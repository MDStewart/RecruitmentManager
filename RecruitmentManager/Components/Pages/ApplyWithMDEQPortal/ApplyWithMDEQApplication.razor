@page "/candidate-application/{CId?}"

@using System.Runtime.InteropServices.JavaScript
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore
@using RecruitmentManager.Components.Layout
@using RecruitmentManager.Data
@using RecruitmentManager.Models
@using RecruitmentManager.Services

@layout CandidateLayout
@inject HRMSService Service

<h3>Apply with MDEQ</h3>

<dialog open="@submitted">
    <p>@AlertMessage</p>
    <form method="dialog">
        <button onclick="window.location.href='@location';" auto>Close</button>
    </form>
</dialog>

<div class="container">
    <p><strong>Position:</strong> @Job.Position</p>
    <p><strong>PIN:</strong> @Job.PIN</p>
    <p><strong>Starting Salary:</strong> @Job.StartingSalary.ToString("C2")</p>
    <p><strong>Minimum Qualifications:</strong> @Job.MinimumQualifications</p>
    <p><strong>Primary Functions:</strong> @Job.PrimaryFunctions</p>
    <p><strong>Special Requirements:</strong> @Job.SpecialRequirements</p>
</div>

<EditForm FormName="candidate-application" EditContext="EditContext" OnSubmit="SubmitCandidateApplication">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label for="firstName">
            First Name <span class="required">*</span>
        </label>
        <InputText id="firstName" @bind-Value="Model!.FirstName" DisplayName="First Name" class="required" />
    </div>

    <div>
        <label for="lastName">
            Last Name <span class="required">*</span>
        </label>
        <InputText id="lastName" @bind-Value="Model.LastName" DisplayName="Last Name" class="required" />
    </div>

    <div>
        <label for="preferredName">
            Preferred Name
        </label>
        <InputText id="preferredName" @bind-Value="Model.PreferredName" DisplayName="Preferred Name" />
    </div>

    <div>
        <label>
            Email <span class="required">*</span>
        </label>
        <InputText @bind-Value="Model.Email" DisplayName="Email" class="required" />
    </div>

    <div>
        <label>
            Phone <span class="required">*</span>
        </label>
        <InputText @bind-Value="Model.Phone" DisplayName="Phone" class="required" />
    </div>

    <div>
        <label>
            Highest Level of Education Completed
        </label>
        <InputSelect class="required" @bind-Value="Model.Education" DisplayName="Highest Level of Education">
            <option value="GED">GED</option>
            <option value="High School">High School</option>
            <option value="Associate Degree">Associate Degree</option>
            <option value="Bachelor's Degree">Bachelor's Degree</option>
            <option value="Master's Degree">Master's Degree</option>
            <option value="PhD">PhD</option>
        </InputSelect>
    </div>

    <div>
        <label>
            Major
        </label>
        <InputText @bind-Value="Model.Major" DisplayName="Major" />
    </div>

    <div class="toggleInput">
        <label for="notGraduated">
            I have not graduated
            <input type="checkbox" name="notGraduated" id="notGraduated" value="false" @onclick="() => {hidden = !hidden;}" />
        </label>

        <div id="optionalContent">
            <label for="graduationDate">
                Expected graduation:
            </label>
            <InputDate id="graduationDate" @bind-Value="Model.ExpectedGraduationDate" />
        </div>
    </div>

    <div>
        <label for="industries">
            Industries
        </label>
        <p> <span class="description">Please list industries you find most applicable to your experience or personal interest.</span></p>

        <InputTextArea id="industries" DisplayName="Industries" @bind-Value="Model!.Industries"></InputTextArea>
    </div>

    <div>
        <label for="resume">
            Resume
        </label>
        <InputFile type="file" id="resume" />
    </div>

    <div>
        <label for="eligibility">
            I am eligible for employment with the State of Mississippi.
            <input type="checkbox" id="eligibility" value="true" @onclick="() => {disabled = !disabled;}" />
        </label>
        <details>
            <summary>
                Do you meet our employment eligibility?
            </summary>

            <ol type="A">
                <li>
                    Any male between the ages of 18 and 26 must be registered with the Selective Service to qualify for employment with the State of Mississippi. Upon hire, applicants must be registered with the Selective Service, if applicable.
                </li>

                <li>
                    MDEQ only employs natural born or naturalized United States citizens or those who are authorized to work in the United States by holding a permanent resident card (i.e. a green card). Upon hire, applicants must be able to provide proof of employment eligibility.
                </li>
            </ol>
        </details>
    </div>

    <div>
        <button type="submit">Submit</button>  <button type="reset">Cancel</button>
    </div>

</EditForm>


@code {
    [SupplyParameterFromForm]
    public Candidate? Model { get; set; }
    public Job Job { get; set; }
    private EditContext? EditContext { get; set; }

    [Parameter]
    public string? CId { get; set; }

    private bool hidden = true;
    private bool disabled = true;
    private string? AlertMessage { get; set; }
    private string location = "";
    private bool submitted = false;


    protected override void OnInitialized()
    {
        Model ??= new() { ExpectedGraduationDate = DateOnly.FromDateTime(DateTime.Now) };
        if (CId != null && CId != "")
        {
            // Retrieve job from database
            Job = Service.GetByJobId(int.Parse(CId!));
        }
        EditContext = new EditContext(Model);
    }

    public void SubmitCandidateApplication()
    {
        Service.Create(Model!);
        AlertMessage = "Application submitted!";
        submitted = true;
        location = "/apply-with-mdeq";
    }

    public void InvalidSubmission()
    {
        AlertMessage = "Invalid submission.";
        location = "/candidate-application";
    }

}